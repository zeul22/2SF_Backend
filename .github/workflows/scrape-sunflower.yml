name: Scrape sunflower offers & auto-merge PR

on:
  schedule:
    # Every 6 hours (UTC): 00:00, 06:00, 12:00, 18:00
    - cron: "0 */6 * * *"
  # Allow manual trigger from GitHub UI
  workflow_dispatch:

jobs:
  scrape-and-pr:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          # ‚ùå removed cache: "npm" because we have no lockfile

      - name: Install dependencies
        run: npm install
        # If your Node project is in a subfolder, add:
        # working-directory: ./2SF_Backend

      - name: Run scraper & generate markdown
        run: npm run scrape
        # working-directory: ./2SF_Backend  # if needed
        # env:
        #   SOME_API_KEY: ${{ secrets.SOME_API_KEY }}

      # Create or update a PR if there are changes
      - name: Create Pull Request with changes
        id: cpr
        uses: peter-evans/create-pull-request@v7
        with:
          commit-message: "chore: update sunflower offers markdown"
          title: "chore: update sunflower offers markdown"
          body: |
            This PR was automatically generated by the scheduled GitHub Action.

            - Scraper ran successfully.
            - Markdown files were updated/created with new sunflower offers.
          branch: "chore/update-sunflower-offers"
          delete-branch: true
          labels: |
            automated
            scraper
          base: main

      # Auto-merge the PR if one was created/updated
      - name: Auto-merge PR
        if: steps.cpr.outputs.pull-request-number != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumberRaw = '${{ steps.cpr.outputs.pull-request-number }}';
            const prNumber = parseInt(prNumberRaw, 10);

            if (isNaN(prNumber)) {
              core.info('No valid PR number found, skipping merge.');
              return;
            }

            core.info(`Attempting to merge PR #${prNumber}...`);

            await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: con
